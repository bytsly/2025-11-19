# 🌐 Captive Portal（强制门户）配置说明

## 问题描述
连接WiFi热点后，设备没有自动弹出欢迎页面，需要手动打开浏览器访问。

## 什么是Captive Portal？

Captive Portal（强制门户）是一种网络访问控制技术：
- 当设备连接到WiFi后，**自动弹出**登录页面或欢迎页面
- 常见于酒店WiFi、机场WiFi、商场WiFi等场景
- iOS/Android/Windows都支持这个功能

### 工作原理
```
1. 设备连接WiFi
2. 系统自动访问检测URL（如 connecttest.txt）
3. DNS服务器劫持请求，返回热点IP
4. 系统检测到重定向，自动弹出浏览器
5. 显示欢迎页面
```

## 🔧 已实现的功能

### 1. DNS劫持服务 ✅
新增文件：`backend/services/dns_service.py`

**功能**:
- 监听53端口（DNS端口）
- 劫持所有DNS查询
- 将所有域名解析到热点IP (192.168.137.1)
- 实时日志显示劫持情况

**技术特点**:
```python
- 独立线程运行
- 支持所有DNS查询类型
- 自动过滤系统检测请求
- 详细的控制台日志
```

### 2. 自动启动/停止 ✅
修改文件：`backend/services/hotspot_service.py`

**创建热点时**:
```python
1. 配置WiFi热点
2. 启动热点
3. 自动启动DNS劫持服务  # 新增
4. 返回热点IP地址
```

**停止热点时**:
```python
1. 停止DNS劫持服务  # 新增
2. 停止WiFi热点
```

### 3. Captive Portal检测端点 ✅
已存在的后端路由：`backend/app.py`

```python
# Android检测
@app.route('/generate_204')  
@app.route('/gen_204')

# iOS检测  
@app.route('/hotspot-detect.html')

# Windows检测
@app.route('/connecttest.txt')

# 所有检测都重定向到 /welcome
```

### 4. 欢迎页面自动跳转 ✅
文件：`frontend/welcome.html`

- 3秒倒计时
- 自动跳转到系统首页
- 详细控制台日志
- 脉冲动画提示

## 🚀 使用方法

### 方法1: 通过GUI启动（推荐）

1. **以管理员身份运行**
   ```bash
   启动GUI.bat  # 右键 -> 以管理员身份运行
   ```

2. **创建热点**
   - 热点名称：`投票抽奖系统`
   - 密码：至少8位
   - 点击"启动系统"

3. **观察日志**
   应该看到：
   ```
   🌐 DNS劫持服务启动，劫持所有请求到 192.168.137.1
   ✅ DNS劫持已启动
   热点创建成功 (已启动DNS劫持)
   ```

4. **手机连接WiFi**
   - 连接名为"投票抽奖系统"的WiFi
   - 输入密码
   - **应该自动弹出欢迎页面**

### 方法2: 通过命令行启动

1. **以管理员身份打开PowerShell**
   ```powershell
   # 进入项目目录
   cd d:\编程\源码包\投票抽奖系统
   
   # 启动系统
   python run.py
   ```

2. **创建热点**（通过管理后台或API）

3. **连接WiFi测试**

## 🧪 测试步骤

### 测试1: DNS劫持是否启动

```powershell
# 在服务器控制台查看日志
# 应该看到：
🌐 DNS劫持服务启动，劫持所有请求到 192.168.137.1
✅ DNS劫持已启动
```

### 测试2: 手机连接测试

#### iOS设备
```
1. 打开WiFi设置
2. 连接"投票抽奖系统"
3. 输入密码
4. ✅ 应该自动弹出Safari浏览器
5. ✅ 显示欢迎页面
6. ✅ 3秒后自动跳转首页
```

#### Android设备
```
1. 打开WiFi设置
2. 连接"投票抽奖系统"  
3. 输入密码
4. ⚠️ 可能显示"需要登录"通知
5. 点击通知
6. ✅ 打开浏览器显示欢迎页
7. ✅ 3秒后自动跳转
```

#### Windows设备
```
1. 连接WiFi
2. ⚠️ 可能不会自动弹出
3. 手动打开浏览器
4. 访问任意网址（会被劫持）
5. ✅ 自动跳转到欢迎页
```

### 测试3: DNS劫持验证

在服务器控制台应该看到：
```
📡 DNS劫持: www.baidu.com -> 192.168.137.1 (来自 192.168.137.100)
📡 DNS劫持: www.google.com -> 192.168.137.1 (来自 192.168.137.101)
```

### 测试4: 手动测试

手机连接WiFi后，手动测试：
```
# 方法1: 访问任意网址
在浏览器输入: www.baidu.com
结果: 应该跳转到欢迎页

# 方法2: 直接访问热点IP
在浏览器输入: 192.168.137.1:5000
结果: 显示欢迎页

# 方法3: 访问检测端点
在浏览器输入: 192.168.137.1:5000/generate_204
结果: 重定向到欢迎页
```

## ❌ 常见问题

### 问题1: DNS劫持未启动

**症状**: 
- 控制台没有"🌐 DNS劫持服务启动"日志
- 手机连接后不弹出欢迎页

**原因**:
1. 端口53被占用
2. 权限不足
3. 防火墙拦截

**解决方法**:
```powershell
# 1. 检查53端口是否被占用
netstat -ano | findstr :53

# 2. 停止占用53端口的进程（如果有）
# 找到PID，然后：
taskkill /PID <PID> /F

# 3. 以管理员身份重新启动

# 4. 检查防火墙
# 控制面板 -> Windows Defender防火墙 -> 允许应用通过防火墙
# 添加 Python 的入站规则（端口53）
```

### 问题2: iOS不弹出

**症状**: iPhone连接WiFi后没有反应

**原因**:
1. iOS版本过旧
2. DNS劫持未生效
3. iOS缓存了旧的DNS

**解决方法**:
```
1. 断开WiFi重新连接
2. 重启iPhone
3. 手动打开Safari，访问 http://192.168.137.1:5000
4. iOS 12+通常都支持，如果还不行可能是系统问题
```

### 问题3: Android不弹出

**症状**: Android连接后没有通知

**原因**:
1. Android版本不同，表现不一致
2. 某些国产ROM修改了检测机制

**解决方法**:
```
1. 等待5-10秒，可能延迟弹出
2. 手动打开浏览器，访问任意网址
3. 应该会自动跳转到欢迎页
4. 或直接访问: 192.168.137.1:5000
```

### 问题4: Windows不弹出

**症状**: Windows连接WiFi后没有弹窗

**原因**:
- Windows的Captive Portal检测不如移动端
- Windows更倾向于提示而不是自动弹出

**解决方法**:
```
1. 正常现象，Windows通常需要手动打开浏览器
2. 打开浏览器，访问任意网址
3. 会自动跳转到欢迎页
4. 或直接访问: 192.168.137.1:5000
```

### 问题5: 端口53权限错误

**症状**: 
```
OSError: [WinError 10013] 以一种访问权限不允许的方式做了一个访问套接字的尝试
```

**原因**: 端口53需要管理员权限

**解决方法**:
```powershell
# 必须以管理员身份运行
右键 -> 以管理员身份运行:
- 启动GUI.bat
- 或 PowerShell/CMD
```

## 📋 检查清单

在反馈问题前，请确认：

- [ ] 以管理员权限运行
- [ ] 热点已成功启动
- [ ] 控制台显示"DNS劫持服务启动"
- [ ] 手机已连接WiFi
- [ ] 手机能ping通 192.168.137.1
- [ ] 防火墙未拦截53端口
- [ ] 防火墙未拦截5000端口

## 🔍 调试方法

### 1. 查看DNS日志
```
启动系统后，控制台应该显示：
🌐 DNS劫持服务启动，劫持所有请求到 192.168.137.1

手机连接后，应该看到：
📡 DNS劫持: www.baidu.com -> 192.168.137.1 (来自 192.168.137.100)
```

### 2. 手机端测试
```bash
# Android/iOS连接WiFi后
# 打开浏览器，输入任意网址
# 例如: www.baidu.com

# 观察服务器控制台
# 应该看到DNS劫持日志
```

### 3. 网络诊断
```powershell
# 在连接WiFi的电脑上
# 测试DNS解析
nslookup www.baidu.com 192.168.137.1

# 应该返回: 192.168.137.1
# 而不是百度的真实IP
```

## ⚙️ 高级配置

### 自定义DNS端口
如果53端口被占用，可以修改端口（不推荐）：

```python
# backend/services/dns_service.py
# 修改默认端口
class DNSServer:
    def __init__(self, redirect_ip: str = '192.168.137.1', port: int = 5353):
        # 改为5353或其他端口
```

**注意**: 修改端口后，Captive Portal可能失效

### 禁用DNS劫持
如果不需要自动弹出功能：

```python
# backend/services/hotspot_service.py
# 注释掉DNS启动代码
# dns_result = start_dns_server(hotspot_ip)
```

## 📖 技术文档

### DNS劫持原理
```
1. 用户设备: "www.baidu.com的IP是什么？"
2. DNS服务器: "是 192.168.137.1"（劫持）
3. 用户浏览器: 访问 http://192.168.137.1:5000
4. 后端路由: 重定向到 /welcome
5. 显示欢迎页面
```

### Captive Portal检测流程
```
iOS/Android/Windows:
1. 连接WiFi
2. 访问检测URL (如 connecttest.txt)
3. 检测HTTP状态码/内容
4. 如果被重定向 -> 判定为Captive Portal
5. 自动弹出浏览器
```

## 🎯 预期效果

### 完美流程
```
1. 启动系统（管理员权限）
   ✅ 看到"DNS劫持服务启动"

2. 手机连接WiFi
   ✅ 自动弹出浏览器
   ✅ 显示欢迎页面
   ✅ 倒计时: 3 -> 2 -> 1
   ✅ 自动跳转到系统首页

3. 用户可以：
   ✅ 点击"开始投票"
   ✅ 点击"查看抽奖"
   ✅ 正常使用系统
```

## 📝 更新日志

**v2.0 - 2025-10-17**
- ✅ 新增DNS劫持服务
- ✅ 集成到热点创建流程
- ✅ 自动启动/停止DNS服务
- ✅ 详细日志输出
- ✅ 支持iOS/Android/Windows检测

**v1.0 - 初始版本**
- ✅ 基础Captive Portal端点
- ✅ 欢迎页面
- ✅ 自动跳转功能

---

**文档版本**: v2.0  
**最后更新**: 2025-10-17  
**维护者**: AI助手
